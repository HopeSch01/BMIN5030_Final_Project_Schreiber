---
title: "Analyzing Influenza Trends and Creating Seasonal Thresholds"
subtitle: "BMIN5030 Final Project"
author: "Hope Schreiber"
format: html
editor: visual
number-sections: true
embed-resources: true
---

------------------------------------------------------------------------

## Overview {#sec-overview}

The goal of this project is to explore trends in seasonal influenza-like illness (ILI) cases. This includes demographic trends in regional hospitalization rates, overall case trends in Pennsylvania, and the use of historical data to create seasonal influenza thresholds. The data utilized will be from the CDC's FluVIew Interactive database \[1\]. This is an online tool that provides publicly available, weekly ILI data at the state and regional level. The overall purpose of this project is to apply the threshold methods established in this project to Penn's own community, with the help of Sidney P and Kendra T (Epidemiologist and Data Analyst on the Public Health team at Penn Wellness). They have provided guidance on data organization and visualization, as well as dissemination of results.

[BMIN5030 Final Project GitHub Repository](https://github.com/HopeSch01/BMIN5030_Final_Project_Schreiber)

## Introduction {#sec-introduction}

Seasonal influenza infects roughly 1 billion people each year \[2\]. Influenza is one of the most common respiratory viruses after the common cold. The best way to prevent infection is receiving your annual influenza vaccine. This vaccine is designed to protect you against three main groups of Flu A and Flu B \[3\]. In order to select the three vaccine virus components, researchers turn to historical influenza data. The surveillance data collected in the previous influenza season not only gives researchers information on how to formulate vaccines, but also provides public health professionals with information on the best ways to target demographics most at risk.

Another important influenza surveillance tool is the use of thresholds. To capture influenza (flu) season severity both actively and retrospectively, the Center for Disease Control and Prevention (CDC) uses intensity thresholds \[4\]. An intensity threshold is established from data gathered during previous flu seasons, and is then used to assess how severe the current flu season is in comparison \[4\]. They help researchers decide how severe flu activity is during peak flu season, and how severe the season was as a whole once it is finished. This information helps to guide public health action such as targeted messaging and prevention measures.

There is not a "gold standard" for calculating intensity thresholds, and multiple methods exist. In 2012, the World Health Organization (WHO) established a new method for defining flu thresholds \[5\]. It utilizes means and standard deviation from historical flu data, and the WHO released a standard guide for determining seasonal and alert thresholds \[6\]. Following the WHO method, the moving epidemic model (MEM) was established for calculating influenza intensity thresholds. It also uses historical data, but involves more statistics and relies heavily on consecutive seasons of data \[7\]. An R package has been created to guide MEM use \[8\].

The CDC collaborates with state health departments and other clinical laboratories to maintain the U.S. influenza surveillance system \[1\]. Information on outpatient visits is reported by partners through the Influenza-like Illness Surveillance Network (ILINet) \[1\]. More than 110 million patient visits were reported during the 2022-23 season \[1\]. This is where the Public Health Team at Penn Wellness reports weekly ILI cases among students. With robust historical data available, seasonal flu thresholds can be established in Pennsylvannia to better understand current flu activity. This is a project that is rooted in the core epidemiological task of surveillance, but also includes statistical modeling skills and relevance to virology. Information from this project can help inform seasonal flu thresholds on UPenn's own campus. The Public Health Team at Penn Wellness collects weekly flu data, and maintains historical flu data spanning back to 2009. There is an opportunity for this project to have a real impact on our own campus community.

## Methods {#sec-methods}

The data utilized for this project is from the U.S. influenza surveillance system (FluView) in collaboration with the CDC \[1\]. All data used in this project is at the state and regional level.

There is an important distinction between an ILI case and a diagnosed influenza case. An ILI case is defined in this system as "a fever (temperature of 100°F \[37.8°C\] or greater) and a cough and/or sore throat. ILINet will capture any visit due to any respiratory pathogen that presents with this case definition. In medical records, this appears as diagnostic code J11.1. If a patient tests positive for Influenza A or Influenza B, they will receive a diagnostic code of J10.1 \[9\].

In order to analyze case trends in Pennsylvania and create seasonal influenza thresholds, data specifically from ILINet was utilized. This includes information on outpatients visits to health care providers for respiratory illness. This setting most closely aligns to that of Penn students, which is why it was chosen for the threshold portion of this project.

To explore the relationship between different demographic trends and Influenza more broadly, data at the regional level was analyzed. This includes information from 110 U.S. Influenza Collaborating Laboratories and 240 National Respiratory and Enteric Virus Surveillance System Laboratories \[1\]. This data set includes information on virus type, age, race, and sex.

#### Loading and Cleaning Data

```{r}

#installing package for MEM method 
install.packages("mem", repos = "https://cloud.r-project.org")

#installing other relevant packages
install.packages("sf", repos = "https://cloud.r-project.org")
install.packages("tidycensus", repos = "https://cloud.r-project.org")

#loading necessary packages 
library(tidyverse)
library(readr)
library(lubridate)
library(broom)
library(zoo)
library(ggplot2)
library(mem)
library(tidyverse)
library(sf)
library(tidycensus)
library(scales)
```

```{r}

#loading in PA ILINet data from 2014-2025 

ILINet <- read_csv("C:/Users/hopeh/Downloads/Fall 2025/EPID 6000 Data Science for Biomedical Informatics/Final Project/FluViewPhase2Data_USE/ILINet.csv")

#keeping only relevant columns 
ILINet <- ILINet |>
  select("REGION TYPE", "REGION", "YEAR", "WEEK", "%UNWEIGHTED ILI", "ILITOTAL", "TOTAL PATIENTS" )

#renaming for clarity 
names(ILINet)[names(ILINet) == "%UNWEIGHTED ILI"] <- "percent.ili"

#checking if there are any missing values 
any(is.na(ILINet)) #no missing


#Cleaning PA ILINet Case Data

ILINet_clean <- ILINet |>
  mutate(
    #Creating a flu season variable
    flu.season = case_when(
      WEEK >= 40 ~ paste0(YEAR, "/", substr(YEAR + 1, 3, 4)), #Oct-Dec belong to season starting that year
      TRUE       ~ paste0(YEAR - 1, "/", substr(YEAR, 3, 4)), #All other weeks  
    )
  ) |>
  
#Check if each season has a week 53 (not typical, but happens in some calendar years)
  group_by(flu.season) |>
  mutate(
    has_week_53 = any(WEEK == 53)
  ) |>
  ungroup()

#Organizing CDC week variable to match with flu.season variable
ILINet_clean <- ILINet_clean |>
  mutate(WEEK = factor(WEEK, levels = c(40:53, 1:20)))

#View summary 
summary(ILINet_clean)

```

To utilize MEM, we need baseline seasons and a validation season. With the years available on ILINet, seasons 2014/15 through 2023/24 can be used to establish thresholds, and these will be validated on season 2024/25.

```{r}

#Creating a Validation Year
baseline.seasons <- ILINet_clean |>
  filter(flu.season %in% c("2014/15", "2015/16", "2016/17", "2017/18", 
                       "2018/19", "2019/20", "2020/21", "2021/22", 
                       "2022/23", "2023/24"))

validation.season <- ILINet_clean |>
  filter(flu.season == "2024/25") 

```

```{r}

#Loading in ILINet data from all states for the years 2014/15 and 2024/25
#This will be used to examine the change in ILI cases over 10 years 

ILINet_AllStates <- read_csv("C:/Users/hopeh/Downloads/Fall 2025/EPID 6000 Data Science for Biomedical Informatics/Final Project/BMIN5030_Final_Project_Schreiber/ILINet_PAChange.csv")

#keeping only relevant columns 
ILINet_AllStates <- ILINet_AllStates |>
  select("REGION TYPE", "REGION", "YEAR", "WEEK", "ILITOTAL", "TOTAL PATIENTS" ) |>
  na.omit(ILINet_AllStates)

#renaming for clarity 
names(ILINet_AllStates)[names(ILINet_AllStates) == "%UNWEIGHTED ILI"] <- "percent.ili"


#Cleaning ILINet All States Data
ILINet_AllStates_clean <- ILINet_AllStates |>
  mutate(
    #Creating a flu season variable
    flu.season = case_when(
      WEEK >= 40 ~ paste0(YEAR, "/", substr(YEAR + 1, 3, 4)), #Oct-Dec belong to season starting that year
      TRUE       ~ paste0(YEAR - 1, "/", substr(YEAR, 3, 4)), #All other weeks  
    ))


```

#### Overview of Data

```{r}

##ILINet Data
head(ILINet_clean)
dim(ILINet_clean)
glimpse(ILINet_clean)

```

The ILINet_clean dataframe has 9 variables and 520 rows of data. In this project, the variables primarily utilized will be WEEK, percent.ILI, flu.season, and week.in.season. The WEEK variable corresponds to CDC week. A typical flu season starts around CDC week 40, and ends around CDC week 20. This is why we re-ordered this variable earlier. We want to view figures starting at CDC week 40. The percent.ili variable provides the percent of medical visits related to an ILI diagnoses during any given week. It is the ILITOTAL variable divided by the TOTAL PATIENTS variable. We will define our flu thresholds and intensity levels using percent.ili.


## Results {#sec-results}

#### Exploring Pennsylvania Historical ILI Case Trends

```{r}

#simple table
ILINet_clean |>
  group_by(flu.season) |>
  summarize(
    peak_week = WEEK[which.max(ILITOTAL)],
    peak_cases = max(ILITOTAL),
    peak_percent = max(percent.ili)
  )

#Total ILI Cases by CDC Week
ggplot(ILINet_clean, aes(x = WEEK, y = ILITOTAL, color = flu.season, group = flu.season)) +
  geom_line(linewidth = 1.2) +
  labs(
    x = "Week in Season",
    y = "Total ILI Cases",
    color = "Flu Season"
  ) + theme_minimal()


#Peak Timing of ILI Cases 
ggplot(ILINet_clean, aes(x = flu.season, y = WEEK, size = ILITOTAL)) +
  geom_point(alpha = 0.5)



```
As seen in both figures, ILI cases typically peak at the very end and beginning of the year (November - February). We can also see the total number of cases differs drastically depending on the season. The 2017/18 season had an extremely high peak, and it can be seen that last flu season (2024/25) had a large peak around a similar time. Some flu seasons saw peaks earlier in the season, such as 2022/23 and 2023/24. Other seasons saw later peaks, such as 2019/20. 

```{r}

#Trend over CDC week 
lm_rate_week <- lm(percent.ili ~ WEEK, data = ILINet_clean)
summary(lm_rate_week)

#Trend over season 
lm_rate_season <- lm(percent.ili ~ flu.season, data = ILINet_clean)
summary(lm_rate_season)


```
It can be seen that ILI rates increase over the season, peaking around week 53, and then start to decrease around week 13. This aligns with what we saw in the previous figures. 

Comparing flu seasons, the ILI rate in PA does not generally differ significantly from the 2014/15 season, except for 2021/22, which had a significantly lower ILI rate. 


```{r}

#Creating a heat map to show change in total ILI across all states

ili_change <- ILINet_AllStates_clean |>
  group_by(REGION, flu.season) |>
  summarize(
    total_ili = sum(ILITOTAL, na.rm = TRUE),
    total_patients = sum(`TOTAL PATIENTS`, na.rm = TRUE)
  ) |>
  mutate(percent_ili = (total_ili / total_patients) * 100) |>
  select(REGION, flu.season, percent_ili) |>
  pivot_wider(names_from = flu.season, values_from = percent_ili) |>
  mutate(change = `2024/25` - `2014/15`)

print(ili_change)

states <- get_acs(
  geography = "state",
  variables = "B01001_001",
  year = 2020,
  geometry = TRUE
) |>
  filter(!NAME %in% c("Alaska", "Hawaii", "Puerto Rico"))

ILI_map_data <- states |>
  left_join(ili_change, by = c("NAME" = "REGION"))


ggplot(ILI_map_data) +
  geom_sf(aes(fill = change), color = "gray30", size = 0.3) +
  scale_fill_gradient2(
    low = "#2166ac", 
    mid = "white", 
    high = "#b2182b",
    midpoint = 0,
    name = "Change in\nPercent ILI\n(percentage points)",
    labels = function(x) sprintf("%.1f%%", x)
  ) +
  labs(
    title = "Change in Percent ILI: 2024/25 vs 2014/15",
    subtitle = "By State"
  ) +
  theme_void() +
  theme(
    plot.title = element_text(size = 16, face = "bold", hjust = 0.5),
    plot.subtitle = element_text(size = 12, hjust = 0.5),
    legend.position = "right",
    plot.background = element_rect(fill = "white", color = NA),
    panel.background = element_rect(fill = "white", color = NA)
  )

```
This figure shows the change in percent ILI from 2014/15 to 2024/25. There does not appear to be any strong geographic trends in change in percent ILI. For PA specifically, we see very little change. States along the western coast appear to have a greater change in percent ILI, as well as many states in the southeast.

### Establishing thresholds using MEM method

The MEM model is a similar yet slightly more sophisticated version of the WHO method. It uses automated algorithms to identify epidemic periods. This method was established by Vega and Lozano in 2013 and has been used previously to establish epidemic thresholds in European countries \[7\]. There is an R package available to download with a reference manual which was referred to throughout this project \[8\].

The MEM method has three main steps:

-   Determine epidemic timing.

    -   This means identifying the start of influenza season, how long it is, and when it ends for each historical season available.

-   Calculate baseline and epidemic thresholds.

    -   To do this, we use the previously established pre-epidemic and post-epidemic values.

-   Calculate intensity thresholds.

    -   This includes creating a threshold for each severity level (medium, high, very high).

```{r}

### Step 1: Prepping data in MEM Format 

ILINet_clean_mem <- ILINet_clean |>
filter(flu.season %in% c("2014/15", "2015/16", "2016/17", "2017/18",
"2018/19", "2019/20", "2020/21", "2021/22",
"2022/23", "2023/24")) |>
filter(WEEK != 53) |> # remove week 53 so all seasons have 52 weeks
select(flu.season, WEEK, percent.ili) |>
arrange(flu.season, WEEK)


#To use MEM, we need our data in wide format (each season is a row)
mem_data <- ILINet_clean_mem |>
  pivot_wider(
    names_from = WEEK,
    values_from = percent.ili,
    names_prefix = "week_"
  ) |>
  #removing the season column, but keeping it for reference
  select(-flu.season)

#add row names (season labels)
rownames(mem_data) <- ILINet_clean_mem |>
  distinct(flu.season) |>
  pull(flu.season)

#check for any NA values - if greater than 10% are missing in a season, it will need to be excluded to use MEM 
na_summary <- data.frame(
  season = rownames(mem_data),
  n_weeks = ncol(mem_data),
  n_missing = rowSums(is.na(mem_data)),
  pct_missing = round(100 * rowSums(is.na(mem_data)) / ncol(mem_data), 1)
)

na_summary  #there is no missing, so we can include all available seasons

```

To visualize the data, we can plot our ILI curves by season over CDC weeks. This will allow us to see if there are any outliers in our data.

```{r}

matplot(t(mem_data), type = "l", lty = 1, col = "gray",
        xlab = "Week", ylab = "Percent ILI",
        main = "ILI Curves by Season")

```

We can see that a few seasons have very sharp peaks, close to 7% ILI. This will be important to keep in mind as we determine parameters in the MEM model.

Now, we will run the MEM model. The majority of the MEM analysis uses the "memmodel()" function. This identifies epidemic periods for each season, calculates the epidemic threshold, and calculates the intensity thresholds. A more detalied explanation of each parameter can be found in the MEM package manual \[8\].

Any parameter ending in '.threshold' affects the epidemic threshold, and any parameter ending in '.intensity' affects the intensity levels. There are six parameter options for i.type.threshold and i.type.parameter. Vega et al. recommends using the geometric mean for both, but there is no 'best practice' and the choice for each parameter is data-specific. The national epidemic threshold for influenza during the 2023-24 season was 2.9% \[1\]. For this project, I tested each i.type.threshold option and chose the one which gave me an epidemic threshold closest to 2.9%. From there, I chose an i.type.parameter that did not give any intensities less than the epidemic threshold, and which had the most even spread. For all other parameters, I primarily chose those recommended by Vega et al.

One other important parameter to mention is i.level.intensity. This parameter defines the percentiles used to classify the epidemic peak intensity into "medium", "high" and "very high". MEM uses historical peak values and then applies those percentile cutoffs.

```{r}

###Testing i.type.threshold###

threshold_options <- 1:6

mem_thresholds_results_list <- vector("list", length(threshold_options))

for (i in seq_along(threshold_options)) {
mem_thresholds_results_list[[i]] <- memmodel(
i.data = mem_data,                     #input data
i.type.threshold = threshold_options[i], #epidemic threshold method
i.level.threshold = 0.95,              #95th percentile of historical activity
i.tails.threshold = 1,                 
i.type.intensity = 1,                  #intensity thresholds - this will not affect epidemic threshold measurement 
i.level.intensity = c(0.75, 0.90, 0.975),
i.tails.intensity = 1,                 #no tail adjustment
i.type.curve = 2,                      #normal curve
i.level.curve = 0.95,                  #significance level for curve fit
i.method = 3,                          #moving percentile method (empirical percentiles)
i.param = 2.5,                         #spread of epidemic curve
i.n.max = -1,                          #all weeks considered
i.type.boot = "norm",                  #bootstrap distribution for CIs
i.iter.boot = 10000                    #10,000 bootstrap iterations
)
}

mem_thresholds_results_list[[1]]
mem_thresholds_results_list[[2]]
mem_thresholds_results_list[[3]]
mem_thresholds_results_list[[4]]
mem_thresholds_results_list[[5]]
mem_thresholds_results_list[[6]]


###Testing i.type.intensity###

intensity_options <- 1:6

mem_intensity_results_list <- vector("list", length(intensity_options))

for (i in seq_along(threshold_options)) {
mem_intensity_results_list[[i]] <- memmodel(
i.data = mem_data,                     # input data
i.type.threshold = 3,                  #chosen epidemic threshold method - this value will not affect intensity level measurements 
i.level.threshold = 0.95,              #95th percentile of historical activity
i.tails.threshold = 1,                 
i.type.intensity = intensity_options[i],  #intensity thresholds
i.level.intensity = c(0.75, 0.90, 0.975),
i.tails.intensity = 1,                 #no tail adjustment
i.type.curve = 2,                      #normal curve
i.level.curve = 0.95,                  #significance level for curve fit
i.method = 3,                          #moving percentile method (empirical percentiles)
i.param = 2.5,                         #spread of epidemic curve
i.n.max = -1,                          #all weeks considered
i.type.boot = "norm",                  #bootstrap distribution for CIs
i.iter.boot = 10000                    #10,000 bootstrap iterations
)
}

mem_intensity_results_list[[1]]
mem_intensity_results_list[[2]]
mem_intensity_results_list[[3]]
mem_intensity_results_list[[4]]
mem_intensity_results_list[[5]]
mem_intensity_results_list[[6]]



```

| i.type.threshold parameter value | Epidemic Threshold (%) |
|----------------------------------|------------------------|
| 1 - arithmetic mean + CI         | 2.42                   |
| 2 - geometric mean + CI          | 2.32                   |
| **3 - median + CI**              | **2.63**               |
| 4 - median + bootstrap-based CI  | 2.26                   |
| 5 - arithmetic mean + "point" CI | 3.32                   |
| 6 - geometric mean + "point" CI  | 3.6                    |

| i.type.intensity parameter | Medium (75%) | High (90%) | Very High (97.5%) |
|------------------|------------------|------------------|------------------|
| 1 - arithmetic mean + CI | 2.49 | 2.63 | 2.79 |
| 2 - Log-normal | 2.20 | 2.32 | 2.46 |
| 3 - Empirical percentiles (nonparametric) | 2.26 | 2.27 | 2.35 |
| 4 - Median + MAD (median absolute deviation) | 2.28 | 2.41 | 2.55 |
| **5 - Empirical quantiles with smoothing** | **3.19** | **3.96** | **4.82** |
| **6 - Bootstrap method** | **2.84** | **3.76** | **5.15** |

Using the median + CI for i.type.threshold resulted in an epidemic threshold of 2.63%. With this value, method 5 and 6 resulted in meaningful i.type.intensity parameters. I decided to use method 5 for earlier detection during active flu season.

```{r}

#Establishing final model with chosen parameters


mem_final <- memmodel(
i.data = mem_data,                     #input data
i.type.threshold = 3,                  #median + CI
i.level.threshold = 0.95,              #95th percentile of historical activity
i.tails.threshold = 1,                 
i.type.intensity = 5,                  #empirical quantiles with smoothing 
i.level.intensity = c(0.75, 0.90, 0.975),
i.tails.intensity = 1,                 #no tail adjustment
i.type.curve = 2,                      #normal curve
i.level.curve = 0.95,                  #significance level for curve fit
i.method = 3,                          #moving percentile method (empirical percentiles)
i.param = 2.5,                         #spread of epidemic curve
i.n.max = -1,                          #all weeks considered
i.type.boot = "norm",                  #bootstrap distribution for CIs
i.iter.boot = 10000                    #10,000 bootstrap iterations
)

mem_final

```

Here is the final epidemic threshold and intensity thresholds from the MEM model:

-   Epidemic Threshold: 2.63%

-   Medium Intensity: 3.19%

-   High Intensity: 3.96%

-   Very High Intensity: 4.82%

```{r}

###Step 3: Extracting Epidemic Timing 

#storing the epidemic threshold 
pre_epidemic_threshold <- mem_final$epidemic.threshold[1]

#reshaping back to long format (one row per week per season)
epidemic_timing <- mem_data |>
  as.data.frame() |>
  mutate(season = rownames(mem_data)) |>
  pivot_longer(
    cols = starts_with("week_"),
    names_to = "cdc_week",
    values_to = "percent_ili",
    names_prefix = "week_"
  ) |>
  mutate(
    cdc_week = as.numeric(cdc_week),
    #indicate whether ILI rate that week is above epidemic threshold 
    above_threshold = percent_ili >= pre_epidemic_threshold 
  ) |>
  group_by(season) |>
  summarise(
    #Epidemic start: first week above threshold 
    epidemic_start_cdc = ifelse(any(above_threshold), 
                               first(cdc_week[above_threshold]), 
                               NA),
    #Epidemic end: last consecutive week above threshold
     epidemic_end_cdc = ifelse(any(above_threshold), 
                             last(cdc_week[above_threshold]), 
                             NA),
    #Peak week
    peak_week_cdc = cdc_week[which.max(percent_ili)],
    #Peak percent ili
    peak_value = max(percent_ili, na.rm = TRUE),
    #Count weeks above threshold
    weeks_above_threshold = sum(above_threshold, na.rm = TRUE),
    .groups = "drop"
  ) |>
  mutate(
  #Calculate duration (from first to last week above threshold)
  epidemic_duration = ifelse(
  epidemic_end_cdc >= epidemic_start_cdc,
  epidemic_end_cdc - epidemic_start_cdc + 1,        
  (epidemic_end_cdc + 52) - epidemic_start_cdc + 1 #have to account for how our cdc week data wraps around 
))


#Table for epidemic timing
epidemic_timing_table <- epidemic_timing |>
  select(
    Season = season,
    `Start (CDC Week)` = epidemic_start_cdc,
    `End (CDC Week)` = epidemic_end_cdc,
    `Duration (weeks)` = epidemic_duration,
    `Peak (CDC Week)` = peak_week_cdc,
    `Peak ILI (%)` = peak_value
  ) |>
  mutate(`Peak ILI (%)` = round(`Peak ILI (%)`, 2))


epidemic_timing_table


```

The epidemic_timing_table provides all of the information for visualizing our MEM. We can see there is some variability in the duration of "epidemic" influenza activity for each season, though most seasons reach the epidemic threshold around the same time. 

```{r}

###Step 4: Visualizing MEM Results

#reshaping data for plotting 
mem_data_long <- ILINet_clean_mem |>
  #keep only flu seasons included in MEM analysis 
  filter(flu.season %in% rownames(mem_data)) |>
  mutate(
    #creates column to indicate if ILI rate is above epidemic threshold 
    above_threshold = percent.ili >= mem_final$epidemic.threshold[1],
    above_threshold = factor(above_threshold, levels = c(FALSE, TRUE), 
        labels = c("Below Threshold", "Above Threshold"))
)

##Plot 1: All Seasons With Thresholds##
plot_mem_all_seasons <- ggplot(mem_data_long, 
                               aes(x = WEEK, y = percent.ili)) +
  geom_line(aes(group = flu.season), color = "gray70", alpha = 0.5) +
  geom_point(aes(color = above_threshold), size = 1.5, alpha = 0.6) +
  
  #Add threshold lines
  geom_hline(yintercept = mem_final$epidemic.threshold[1], 
             color = "blue", linetype = "dashed", size = 1) +
  geom_hline(yintercept = mem_final$intensity.thresholds[1], 
             color = "yellow3", size = 0.8) +
  geom_hline(yintercept = mem_final$intensity.thresholds[2], 
             color = "orange", size = 0.8) +
  geom_hline(yintercept = mem_final$intensity.thresholds[3], 
             color = "red", size = 0.8) +
  
  #Add labels
  annotate("text", x = 30, 
           y = mem_final$epidemic.threshold[1],
           label = paste0("Epidemic Threshold: ", round(mem_final$epidemic.threshold[1], 2), "%"),
           vjust = -0.5, color = "blue", size = 3) +
  annotate("text", x = 30,
           y = mem_final$intensity.thresholds[1],
           label = paste0("Medium: ", round(mem_final$intensity.thresholds[1], 2), "%"),
           vjust = -0.5, color = "yellow4", size = 3) +
  annotate("text", x = 30,
           y = mem_final$intensity.thresholds[2],
           label = paste0("High: ", round(mem_final$intensity.thresholds[2], 2), "%"),
           vjust = -0.5, color = "orange", size = 3) +
  annotate("text", x = 30,
           y = mem_final$intensity.thresholds[3],
           label = paste0("Very High: ", round(mem_final$intensity.thresholds[3], 2), "%"),
           vjust = -0.5, color = "red", size = 3) +
  
  scale_color_manual(
    values = c("Below Threshold" = "steelblue", 
               "Above Threshold" = "coral")
  ) +
  
  theme_minimal() +
  labs(
    title = "Pennsylvania Influenza Thresholds - MEM Method",
    subtitle = paste0("Based on ", length(unique(mem_data_long$flu.season)), " seasons"),
    x = "CDC Week",
    y = "Percent ILI (%)",
    color = "Epidemic Period"
  ) +
  theme(legend.position = "bottom")

print(plot_mem_all_seasons)
ggsave("plot_mem_all_seasons.png", plot = plot_mem_all_seasons)

```
This figure shows the established epidemic threshold and intensity thresholds plotted on the nine historical influenza seasons used to derive those values. Percent ILI is on the y-axis, and CDC week is on the x-axis. All blue points are CDC weeks below the epidemic threshold, and all red points are CDC weeks above the epidemic threshold. Again, we can see that trends in peaks vary across seasons, but we see similar rises and falls in the beginning and end of each season.

```{r}

 ###Step 5: Applying MEM Thresholds to the Current Season (2024/25)

#Classify each week to a threshold
classification <- validation.season |>
  filter(!is.na(percent.ili), !is.na(WEEK)) |>
  mutate(
    intensity_level = case_when(
      percent.ili < mem_final$epidemic.threshold[1] ~ "Baseline",
      percent.ili >= mem_final$epidemic.threshold[1] & percent.ili < mem_final$intensity.thresholds[1] ~ "Low",
      percent.ili >= mem_final$intensity.thresholds[1] & percent.ili < mem_final$intensity.thresholds[2] ~ "Medium",
      percent.ili >= mem_final$intensity.thresholds[2] & percent.ili < mem_final$intensity.thresholds[3] ~ "High",
      percent.ili >= mem_final$intensity.thresholds[3] ~ "Very High",
      TRUE ~ "Unknown"
    ),
    intensity_level = factor(
      intensity_level,
      levels = c("Baseline", "Low", "Medium", "High", "Very High")
    ),
    above_epidemic_threshold = percent.ili >= mem_final$epidemic.threshold[1],
    WEEK = factor(WEEK, levels = c(40:53, 1:20))
  )

classification <- classification |>
  mutate(WEEK_num = as.numeric(WEEK))

#Find epidemic alert
first_alert <- classification |>
  filter(above_epidemic_threshold) |>
  slice(1)

## Plot 2. Season 2024/25 With MEM Thresholds
plot_season_2024_2025 <- ggplot(classification, 
                           aes(x = WEEK_num, y = percent.ili)) +
  # Shaded regions for intensity levels
  annotate("rect", xmin = -Inf, xmax = Inf,
           ymin = 0, ymax = mem_final$epidemic.threshold[1],
           fill = "lightblue", alpha = 0.2) +
  annotate("rect", xmin = -Inf, xmax = Inf,
           ymin = mem_final$epidemic.threshold[1], ymax = mem_final$intensity.thresholds[1],
           fill = "lightgreen", alpha = 0.2) +
  annotate("rect", xmin = -Inf, xmax = Inf,
           ymin = mem_final$intensity.thresholds[1], ymax = mem_final$intensity.thresholds[2],
           fill = "yellow", alpha = 0.2) +
  annotate("rect", xmin = -Inf, xmax = Inf,
           ymin = mem_final$intensity.thresholds[2], ymax = mem_final$intensity.thresholds[3],
           fill = "orange", alpha = 0.2) +
  annotate("rect", xmin = -Inf, xmax = Inf,
           ymin = mem_final$intensity.thresholds[3], ymax = Inf,
           fill = "red", alpha = 0.2) +
  
  #Current season data
  geom_line(color = "black", size = 1.2) +
  geom_point(aes(color = intensity_level), size = 4) +
  
  #Add text labels with CDC week
  geom_text(aes(label = paste0("W", WEEK)), 
            vjust = -1, size = 2.5, color = "gray30") +
  
  #Threshold lines
  geom_hline(yintercept = mem_final$epidemic.threshold[1], 
             color = "blue", linetype = "solid", size = 1) +
  geom_hline(yintercept = mem_final$intensity.thresholds[1], 
             color = "yellow3", linetype = "dashed") +
  geom_hline(yintercept = mem_final$intensity.thresholds[2], 
             color = "orange", linetype = "dashed") +
  geom_hline(yintercept = mem_final$intensity.thresholds[3], 
             color = "red", linetype = "dashed") +
  
  scale_color_manual(
    values = c(
      "Baseline" = "steelblue",
      "Low" = "green4",
      "Medium" = "yellow3",
      "High" = "orange",
      "Very High" = "red"
    )
) +
  
  theme_minimal() +
  labs(
    title = "2024/25 Pennsylvania Influenza Season - MEM",
    subtitle = paste0("Epidemic threshold: ", round(mem_final$epidemic.threshold[1], 2), "% ILI"),
    x = "WEEK",
    y = "Percent ILI (%)",
    color = "Intensity Level",
    caption = "Labels show CDC week numbers"
  ) +
  theme(legend.position = "bottom")

print(plot_season_2024_2025)
ggsave("plot_season_2024_2025.png", plot = plot_season_2024_2025)

```
Finally, this figure shows the established epidemic threshold and intensity levels on our "current" influenza season, which in this case is 2024/25. The x-axis shows "week in season", while each point is labeled with the specific CDC week. Percent ILI is again on the y-axis. The the blue line shows the epidemic threshold of 2.63% ILI. We can clearly see that active flu season ("epidemic") starts right after week 51, and ends right around week 11. There was very high ILI activity during weeks 5, 6, and 7. 

## Conclusion

Overall, the MEM is a very useful tool that can be implemented at Penn Wellness to better understand influenza activity on Penn's own campus. The main limitation with this model is deciding which parameter settings work best with the available data. In my future implementation of this work, I plan to include some sensitivity analyses to better decide which parameters align the closest with my data. 

On a broader scale, epidemic thresholds and intensity levels can be used to more accurately inform public health interventions. Certain interventions could be triggered by reaching specific thresholds/intensities. This allows for a more robust and data-driven approach to responding to seasonal influenza outbreaks.  


## References

1.  CDC. U.S. Influenza Surveillance: Purpose and Methods. FluView. March 3, 2025. Accessed October 29, 2025. https://www.cdc.gov/fluview/overview/index.html
2.  The burden of Influenza. Accessed November 26, 2025. https://www.who.int/news-room/feature-stories/detail/the-burden-of-influenza
3.  CDC. Selecting Viruses for the Seasonal Influenza Vaccine. Influenza (Flu). August 28, 2025. Accessed November 26, 2025. https://www.cdc.gov/flu/vaccine-process/vaccine-selection.html
4.  CDC. How CDC Classifies Flu Severity each Season in the United States. Influenza (Flu). November 26, 2024. Accessed October 28, 2025. https://www.cdc.gov/flu/php/surveillance/index.html
5.  Tay EL, Grant K, Kirk M, Mounts A, Kelly H. Exploring a Proposed WHO Method to Determine Thresholds for Seasonal Influenza Surveillance. Cook AR, ed. *PLoS ONE*. 2013;8(10):e77244. doi:10.1371/journal.pone.0077244
6.  *Global Epidemiological Surveillance Standards for Influenza*. World Health Organization; 2013.
7.  Vega T, Lozano JE, Meerhoff T, et al. Influenza surveillance in Europe: establishing epidemic thresholds by the moving epidemic method. *Influenza Other Respir Viruses*. 2013;7(4):546-558. doi:10.1111/j.1750-2659.2012.00422.
8.  Lozano JE. mem: The Moving Epidemic Method. Published online November 26, 2010:2.19. doi:10.32614/CRAN.package.mem
9.  2026 ICD-10-CM Diagnosis Code J10.1: Influenza due to other identified influenza virus with other respiratory manifestations. Accessed November 26,
    2025. https://www.icd10data.com/ICD10CM/Codes/J00-J99/J09-J18/J10-/J10.1
10. CDC. Flu Season. Influenza (Flu). September 26, 2025. Accessed November 3, 2025. https://www.cdc.gov/flu/about/season.html
11. Steiner SH, Grant K, Coory M, Kelly HA. Detecting the start of an influenza outbreak using exponentially weighted moving average charts. *BMC Med Inform Decis Mak*. 2010;10(1):37. doi:10.1186/1472-6947-10-37
