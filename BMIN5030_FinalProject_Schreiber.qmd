---
title: "Creating and Evaluating Seasonal Influenza Thresholds in Philadelphia"
subtitle: "BMIN5030 Final Project"
author: "Hope Schreiber"
format: html
editor: visual
number-sections: true
embed-resources: true
---

------------------------------------------------------------------------

Use this template to complete your project throughout the course. Your Final Project presentation will be based on the contents of this document. Replace the title/name above and text below with your own, but keep the headers. Feel free to change the theme and other display settings, although this is not required.

## Overview {#sec-overview}

The goal of this project is to explore two popular methods for determining intensity thresholds for seasonal in Pennsylvania. The data utilized will be from the CDC's FluVIew Interactive database \[1\]. This is an online tool that provides publicly available, weekly influenza-like illness (ILI) data at the state level. The overall purpose of this project is to apply the methods to Penn's own community, with the help of Sidney P and Kendra T (Epidemiologist and Data Analyst on the Public Health team at Penn Wellness). They have provided guidance on data organization and visualization, as well as dissemination of results.

[BMIN5030 Final Project GitHub Repository](https://github.com/HopeSch01/BMIN5030_Final_Project_Schreiber)

## Introduction {#sec-introduction}

To capture influenza (flu) season severity both actively and retrospectively, the Center for Disease Control and Prevention (CDC) uses intensity thresholds \[2\]. An intensity threshold is established from data gathered during previous flu seasons, and is then used to assess how severe the current flu season is in comparison \[2\]. They help researchers decide how severe flu activity is during peak flu season, and how severe the season was as a whole once it is finished. This information helps to guide public health action such as targeted messaging and prevention measures.

There is not a "gold standard" for calculating intensity thresholds, and multiple methods exist. In 2012, the World Health Organization (WHO) established a new method for defining flu flu thresholds \[3\]. It utilizes means and standard deviation from historical flu data, and the WHO released a standard guide for determining seasonal and alert thresholds \[4\]. The moving epidemic model (MEM) is another method for calculating influenza intensity thresholds. It also uses historical data, but involves more statistics and relies heavily on consecutive seasons of data \[5\]. An R package has been created to guide MEM use \[6\].

The CDC collaborates with state health departments and other clinical laboratories to maintain the U.S. influenza surveillance system \[1\]. Information on outpatient visits is reported by partners through the Influenza-like Illness Surveillance Network (ILINet) \[1\]. More than 110 million patient visits were reported during the 2022-23 season \[1\]. This is where the Public Health Team at Penn Wellness reports weekly ILI cases among students. With robust historical data available, seasonal flu thresholds can be established in Pennsylvannia to better understand current flu activity. Additionally, this provides an opportunity to compare two popular methods in establishing thresholds. This is a project that is rooted in the core epidemiological task of surveillance, but also includes statistical modeling skills and relevance to virology. Information from this project can help inform seasonal flu thresholds on UPenn's own campus. The Public Health Team at Penn Wellness collects weekly flu data, and maintains historical flu data spanning back to 2009. There is an opportunity for this project to have a real impact on our own campus community.

## Methods {#sec-methods}

Describe the data used and general methodological approach used to address the problem described in the @sec-introduction. Subsequently, incorporate full R code necessary to retrieve and clean data, and perform analysis. Be sure to include a description of code so that others (including your future self) can understand what you are doing and why.

The data utilized for this project is from the U.S. influenza surveillance system in collaboration with the CDC \[1\]. All data used in this project is at the state level, though FluView has data available at the regional and national level.

In order to create seasonal influenza thresholds, data specifically from ILINet was utilized. This includes information on outpatients visits to health care providers for respiratory illness. This setting most closely aligns to that of Penn students, which is why it was chosen for this project.

An ILI case is defined in this system as "a fever (temperature of 100°F \[37.8°C\] or greater) and a cough and/or sore throat. ILINet will capture any visit due to any respiratory pathogen that presents with this case definition.

FluView includes other important surveillance data including age group distribution of positive influenza tests, hospitalizations, and mortality. These will also be explored to obtain a complete and accurate picture of ILI activity prior to establishing state level seasonal activity thresholds.

#### Intro/background Exploration

-   line graph of ILI cases by CDC week over the years

    -   ILINet data

-   map showing change in ILI activity?

    -   would need to download data for all states from FluView

-   Flu A versus Flu B

-   Age group distributions

    -   broken down by Flu A versus Flu B

    -   broken down by CDC week

-   hospitalizations

    -   broken down by CDC week

    -   broken down by age

```{r}

#loading necessary packages 
library(tidyverse)
library(readr)
library(lubridate)
library(broom)
library(zoo)
library(ggplot2)

```

```{r}

#loading in PA ILINet data from 2014-2025
ILINet <- read_csv("C:/Users/hopeh/Downloads/Fall 2025/EPID 6000 Data Science for Biomedical Informatics/Final Project/FluViewPhase2Data_USE/ILINet.csv")

#keeping only relevant columns 
ILINet <- ILINet |>
  select("REGION TYPE", "REGION", "YEAR", "WEEK", "%UNWEIGHTED ILI", "ILITOTAL", "TOTAL PATIENTS" )

#renaming for clarity 
names(ILINet)[names(ILINet) == "%UNWEIGHTED ILI"] <- "percent.ili"

#checking if there are any missing values 
any(is.na(ILINet)) #no missing


```

## Results {#sec-results}

Describe your results and include relevant tables, plots, and code/comments used to obtain them. You may refer to the @sec-methods as needed. End with a brief conclusion of your findings related to the question you set out to address. You can include references if you'd like, but this is not required.

#### 1) Establishing thresholds using WHO method

The WHO method for defining thresholds was established in 2012 with the purpose of developing global standards for influenza surveillance \[3\]. It depends on historical data, and aligns previous years on the median week of peak activity. Then thresholds are assigned based on means and standard deviations of the aligned data. The paper by Tay et al. was used as a guide in applying this method to the ILINet data in Pennsylvania.

According to the CDC, the "peak" months of influenza season are October through May \[7\]. We will use this timeline to create our influenza seasons.

```{r}

### Step 1. Establishing Flu Seasons 

#Creating a flu season variable
ILINet_clean <- ILINet |>
  mutate(
    flu.season = case_when(
      WEEK >= 40 ~ paste0(YEAR, "/", substr(YEAR + 1, 3, 4)), #Oct-Dec belong to season starting that year
      WEEK <= 20 ~ paste0(YEAR - 1, "/", substr(YEAR, 3, 4)), #Jan-May belong to to season that started previous year 
      TRUE ~ NA_character_                                    #Weeks 21-39 are not in the typical flu season
    )
  )

#Creating a variable for "week in flu season" - this will help with plotting later 
ILINet_clean <- ILINet_clean |>
  mutate (
    week.in.season = case_when(
      WEEK >= 40 ~ WEEK - 39,  #Weeks 40-52 become 1-13 of "flu season"
      WEEK <= 20 ~ WEEK + 13,  #Weeks 1-20 become 14-33 of "flu season"
      TRUE ~ NA_real_
    )
  )


#Filtering ILINet_clean to only include flu season weeks 
ILINet_clean <- ILINet_clean |>
  filter(!is.na(flu.season)) |>
  arrange(flu.season, week.in.season)

#View summary 
summary(ILINet_clean)

```

With the years available on ILINet, seasons 2014/15 through 2023/24 can be used to establish thresholds, and these will be validated on season 2024/25.

```{r}

### Step 2. Creating Validation Year
baseline.seasons <- ILINet_clean |>
  filter(flu.season %in% c("2014/15", "2015/16", "2016/17", "2017/18", 
                       "2018/19", "2019/20", "2020/21", "2021/22", 
                       "2022/23", "2023/24"))

validation.season <- ILINet_clean |>
  filter(flu.season == "2024/25") 

```

The WHO method requires identifying epidemic weeks to exclude them from baseline \[3\]. If we include epidemic weeks in our baseline, we would inflate the mean and standard deviation, creating thresholds that are too high. There are multiple ways to do this, with the simplest being a visual inspection of potential epidemic periods using a line graph. A more robust approach is 
the within-season percentile method. This will identify epidemic weeks as those are are unusually high relative to other weeks in the same season. Additionally, a moving average will be used to smooth data and reduce noise \[8\].

```{r}

### Step 3. Identifying Epidemic Periods 

epidemic.periods <- function(ILINet_clean, percentile = 0.90) {
  percentile.data <- ILINet_clean |>
    arrange(flu.season, week.in.season) |>
    group_by(flu.season) |>
    mutate(
      #calculating season-specific percentile thresholds
      season.threshold = quantile(percent.ili, probs = percentile, na.rm = TRUE),
      #Weeks above this threshold are considered epidemic weeks 
      above.thresh = percent.ili >= season.threshold,
      #Using moving average to smooth
      ma_3weeks = zoo::rollmean(percent.ili, k = 3, fill = NA, align = "center"), 
      #Identifying peak week in each season
      peak.week = percent.ili == max(percent.ili, na.rm = TRUE) )|>
        ungroup()
  
  #Create a summary for each season        
  epidemic.summary <- percentile.data |>
    group_by(flu.season) |>
    summarise(
      total.weeks = n(),
      epidemic.weeks = sum(above.thresh, na.rm = TRUE),
      percent.epidemic = round(100*epidemic.weeks / total.weeks, 1),
      peak.ili = max(percent.ili, na.rm = TRUE),
      peak.week = week.in.season[which.max(percent.ili)]
    )
  
  return(list(ILINet_clean = percentile.data, summary = epidemic.summary))
}
  
#Next, apply this within-season percentile method to our baseline seasons 
within.season.percent <- epidemic.periods(baseline.seasons, percentile = 0.90)

print(within.season.percent$summary)


############# MAKE THIS CLEANER ##############
##############################################
# Visualize identified epidemic periods
ggplot(within.season.percent$ILINet_clean, aes(x = week.in.season, y = percent.ili)) +
  geom_line(aes(group = flu.season), color = "gray60") +
  geom_point(aes(color = above.thresh), size = 2) +
  geom_point(data = filter(within.season.percent$ILINet_clean, peak.week), 
             color = "red", size = 4, shape = 17) + #Triangle for peak
  facet_wrap(~flu.season, scales = "free_y") +
  scale_color_manual(
    values = c("FALSE" = "blue", "TRUE" = "orange"),
    labels = c("Non-epidemic", "Epidemic")
  ) +
  theme_minimal() +
  labs(
    title = "Epidemic Period Identification (Within-Season 90th Percentile)",
    subtitle = "Red triangles indicate season peaks",
    x = "Week in Season",
    y = "Percent ILI (%)",
    color = "Classification"
  ) +
  theme(legend.position = "bottom")

```
Now, with "epidemic" weeks established, we can move on to exploring baseline (non-epidemic) activity. 

```{r}

### Step 4: Calculating Baseline Activity 

baseline.activity <- within.season.percent$ILINet_clean |>
  filter(!above.thresh) |>   #exclude weeks above 90th percentile in each season
  summarise(
    baseline.mean = mean(percent.ili, na.rm = TRUE),  #calculate mean of baseline weeks
    baseline.sd = sd(percent.ili, na.rm = TRUE),      #calculate standard dev. of baseline weeks
    n.weeks = n()
  )


```

The WHO method defined three levels of flu thresholds: seasonal, average, and alert [3]. When the seasonal threshold is crossed into, this signals the start of flu season. We will define the seasonal threshold as mean + 2 SD (95th percentile), and the alert threshold as mean + 3 SD (99.7th percentile). Tay et al. explains that there is not a mandated approach to choosing these threshold definitions.

```{r}

### Step 5. Calculate WHO Thresholds

thresholds <- baseline.activity |>
  mutate(
    average.threshold = baseline.mean + (2 * baseline.sd),
    alert.threshold = baseline.mean + (3 * baseline.sd)
  )

print(thresholds)

```
Based on our historical flu season data (2014/15 through 2023/24), the seasonal threshold is 3.6% and the alert threshold is 4.5%. Note - these percentages represent the percent of outpatient medical visits associated with an ILI diagnosis in Pennsylvania. 

```{r}

### Visualize WHO Method Results 

#Applying thresholds to current flu season (2024/25)
if(nrow(validation.season) > 0) {
  current.flu.season <- ggplot() +
    #Current season (2024/25) data
    geom_line(
      data = validation.season,
      aes(x = week.in.season, y = percent.ili, group = flu.season),
      color = "black",
      alpha = 0.5
    ) +
    #Adding each threshold line individually
    geom_hline(yintercept = thresholds$baseline.mean, color = "blue", linetype = "dashed", size = 1) +
    geom_hline(yintercept = thresholds$average.threshold, color = "orange", linetype = "dashed", size = 1) +
    geom_hline(yintercept = thresholds$alert.threshold, color = "red", linetype = "dashed", size = 1)
}

print(current.flu.season)


###Still need to make this cleaner###
#For context - blue line is basically mean activity (seasonal threshold); orange line is average threshold, red line is alert threshold
```


-   code used to establish thresholds w/ explanation

-   graph of each year

2\) Establishing thresholds using MEM method

-   mem package code used

-   graph of each year

3\) Some type of sensitivity analysis of two methods

-   don't necessarily have reference data

## Conclusion

This the conclusion. The @sec-results can be invoked here.

## References

1.  CDC. U.S. Influenza Surveillance: Purpose and Methods. FluView. March 3, 2025. Accessed October 29, 2025. https://www.cdc.gov/fluview/overview/index.html
2.  CDC. How CDC Classifies Flu Severity each Season in the United States. Influenza (Flu). November 26, 2024. Accessed October 28, 2025. https://www.cdc.gov/flu/php/surveillance/index.html
3.  Tay EL, Grant K, Kirk M, Mounts A, Kelly H. Exploring a Proposed WHO Method to Determine Thresholds for Seasonal Influenza Surveillance. Cook AR, ed. *PLoS ONE*. 2013;8(10):e77244. doi:10.1371/journal.pone.0077244
4.  *Global Epidemiological Surveillance Standards for Influenza*. World Health Organization; 2013.
5.  Vega T, Lozano JE, Meerhoff T, et al. Influenza surveillance in Europe: establishing epidemic thresholds by the moving epidemic method. *Influenza Other Respir Viruses*. 2013;7(4):546-558. doi:10.1111/j.1750-2659.2012.00422.x
6.  Lozano JE. mem: The Moving Epidemic Method. Published online November 26, 2010:2.19. doi:10.32614/CRAN.package.mem
7.  CDC. Flu Season. Influenza (Flu). September 26, 2025. Accessed November 3, 2025. https://www.cdc.gov/flu/about/season.html
8.  Steiner SH, Grant K, Coory M, Kelly HA. Detecting the start of an influenza outbreak using exponentially weighted moving average charts. *BMC Med Inform Decis Mak*. 2010;10(1):37. doi:10.1186/1472-6947-10-37
